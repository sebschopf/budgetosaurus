{# webapp/templates/webapp/review_transactions_includes/review_transactions_scripts.html #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('editTransactionModal');
        const closeButton = document.querySelector('.close-button');
        const editButtons = document.querySelectorAll('.edit-btn');
        const deleteButtons = document.querySelectorAll('.delete-btn');
        const modalForm = document.getElementById('editTransactionForm');
        const modalFormFieldsContainer = document.getElementById('modal-form-fields');

        // Récupérer les données de catégorie et sous-catégorie du DOM pour la modale
        // Ces scripts sont inclus dans review_transactions.html qui n'a pas les json_script tags.
        // Les données sont passées via la vue get_transaction_form_for_edit.
        let allCategories = [];
        let allSubcategories = [];

        /**
         * Ajoute un pictogramme/badge à côté d'un nom de catégorie.
         * NOTE IMPORTANTE: Le HTML à l'intérieur des balises <option> est souvent ignoré ou mal rendu par les navigateurs.
         * Cette fonction est conservée pour la clarté du code et pour les "data-" attributs, mais l'affichage réel des badges
         * à côté du champ sélectionné est géré par `updateCategoryIconDisplay` en dehors de l'élément <select>.
         * @param {string} categoryName Le nom de la catégorie.
         * @param {boolean} isFundManaged Indique si la catégorie gère un fonds.
         * @param {boolean} isBudgeted Indique si la catégorie est associée à un budget.
         * @param {boolean} isGoalLinked Indique si la catégorie est liée à un objectif d'épargne.
         * @returns {string} Le HTML du nom de catégorie avec le pictogramme. (Visuellement, seul le nom sera affiché dans le dropdown)
         */
        function formatCategoryNameWithIcon(categoryName, isFundManaged, isBudgeted, isGoalLinked) {
            // Les navigateurs ne rendent pas correctement le HTML à l'intérieur des <option>.
            // Nous allons juste retourner le nom de la catégorie.
            // Les informations `isFundManaged`, `isBudgeted`, `isGoalLinked` seront stockées dans les `dataset` de l'option
            // et utilisées par `updateCategoryIconDisplay` pour afficher les badges *à côté* du select.
            return categoryName;
        }

        /**
         * Peuple le dropdown des catégories principales avec les icônes.
         * @param {HTMLElement} selectElement L'élément <select> à peupler.
         * @param {Array} categoriesData Les données des catégories.
         * @param {string|number|null} initialValue La valeur initiale à sélectionner.
         */
        function populateMainCategories(selectElement, categoriesData, initialValue = null) {
            selectElement.innerHTML = '<option value="">Sélectionner Catégorie Principale</option>';
            categoriesData.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                // Le texte de l'option sera juste le nom de la catégorie
                option.textContent = category.name;
                // Les flags sont stockés dans les dataset de l'option
                option.dataset.isFundManaged = category.is_fund_managed;
                option.dataset.isBudgeted = category.is_budgeted;
                option.dataset.isGoalLinked = category.is_goal_linked;
                selectElement.appendChild(option);
            });
            if (initialValue) {
                selectElement.value = initialValue;
            }
            // Déclencher le changement pour mettre à jour les sous-catégories et l'affichage initial de l'icône
            selectElement.dispatchEvent(new Event('change'));
        }

        /**
         * Peuple le dropdown des sous-catégories en fonction d'une catégorie parente sélectionnée.
         * @param {string} parentCategoryId L'ID de la catégorie parente.
         * @param {HTMLElement} subcategorySelectElement L'élément <select> des sous-catégories.
         * @param {string|null} initialSubcategoryId L'ID de la sous-catégorie à pré-sélectionner.
         */
        function loadSubcategories(parentCategoryId, subcategorySelectElement, initialSubcategoryId = null) {
            subcategorySelectElement.innerHTML = '<option value="">Sélectionner une sous-catégorie</option>';
            const subcategoryContainer = subcategorySelectElement.closest('.form-field-group');

            if (parentCategoryId && allSubcategories.length > 0) {
                const childrenOfParent = allSubcategories.filter(cat => cat.parent === parseInt(parentCategoryId));

                if (childrenOfParent.length > 0) {
                    childrenOfParent.forEach(subcategory => {
                        const option = document.createElement('option');
                        option.value = subcategory.id;
                        // Le texte de l'option sera juste le nom de la sous-catégorie
                        option.textContent = subcategory.name;
                        // Les flags sont stockés dans les dataset de l'option
                        option.dataset.isFundManaged = subcategory.is_fund_managed;
                        option.dataset.isBudgeted = subcategory.is_budgeted;
                        option.dataset.isGoalLinked = subcategory.is_goal_linked;
                        subcategorySelectElement.appendChild(option);
                    });
                    if (subcategoryContainer) subcategoryContainer.style.display = 'block';
                } else {
                    if (subcategoryContainer) subcategoryContainer.style.display = 'none';
                }

                if (initialSubcategoryId) {
                    const optionExists = Array.from(subcategorySelectElement.options).some(option => option.value == initialSubcategoryId);
                    if (optionExists) {
                        subcategorySelectElement.value = initialSubcategoryId;
                    }
                }
                updateCategoryIconDisplay(subcategorySelectElement); // Mettre à jour l'icône pour la sous-catégorie
            } else {
                if (subcategoryContainer) subcategoryContainer.style.display = 'none';
                updateCategoryIconDisplay(subcategorySelectElement); // Effacer l'icône si la sous-catégorie est masquée
            }
        }

        /**
         * Ajoute ou met à jour les icônes d'information de la catégorie à côté de l'élément select.
         * Permet d'afficher plusieurs badges (Fonds, Budget, Objectif).
         * @param {HTMLElement} selectElement L'élément <select> de la catégorie.
         */
        function updateCategoryIconDisplay(selectElement) {
            // Supprimer tous les badges existants associés à ce select
            let currentNextSibling = selectElement.nextElementSibling;
            while (currentNextSibling && currentNextSibling.classList.contains('category-info-icon')) {
                const temp = currentNextSibling.nextElementSibling;
                currentNextSibling.remove();
                currentNextSibling = temp;
            }

            const selectedOption = selectElement.options[selectElement.selectedIndex];
            if (selectedOption && selectedOption.value) { // N'ajouter que si une catégorie réelle est sélectionnée
                const isFundManaged = selectedOption.dataset.isFundManaged === 'true'; // 'true' est une chaîne de caractères du dataset
                const isBudgeted = selectedOption.dataset.isBudgeted === 'true';
                const isGoalLinked = selectedOption.dataset.isGoalLinked === 'true';
                
                const parentNode = selectElement.parentNode;

                // Ajouter les badges pertinents
                if (isFundManaged) {
                    const badge = document.createElement('span');
                    badge.classList.add('category-info-icon', 'fund-managed');
                    badge.textContent = 'Fonds';
                    parentNode.insertBefore(badge, selectElement.nextSibling);
                }
                if (isBudgeted) {
                    const badge = document.createElement('span');
                    badge.classList.add('category-info-icon', 'budgeted');
                    badge.textContent = 'Budget';
                    parentNode.insertBefore(badge, selectElement.nextSibling);
                }
                if (isGoalLinked) {
                    const badge = document.createElement('span');
                    badge.classList.add('category-info-icon', 'goal-linked');
                    badge.textContent = 'Objectif';
                    parentNode.insertBefore(badge, selectElement.nextSibling);
                }
            }
        }


        // Ouvrir la modale et charger le formulaire
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const transactionId = this.dataset.transactionId;

                modalFormFieldsContainer.innerHTML = '<p class="text-center text-gray-500">Chargement du formulaire...</p>';
                modal.style.display = 'flex'; 

                fetch(`/get-transaction-form/${transactionId}/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erreur lors du chargement du formulaire de transaction.');
                        }
                        return response.text(); 
                    })
                    .then(html => {
                        modalFormFieldsContainer.innerHTML = html; 

                        // Récupérer les données de catégorie et sous-catégorie du HTML inséré
                        const categoriesDataScript = modalFormFieldsContainer.querySelector('#allCategoriesData');
                        const subcategoriesDataScript = modalFormFieldsContainer.querySelector('#allSubcategoriesData');
                        if (categoriesDataScript && subcategoriesDataScript) {
                            allCategories = JSON.parse(categoriesDataScript.textContent);
                            allSubcategories = JSON.parse(subcategoriesDataScript.textContent);
                        }
                        
                        const hiddenTransactionIdInput = modalFormFieldsContainer.querySelector('input[name="transaction_id"]');
                        if (hiddenTransactionIdInput) {
                            modalForm.action = `/update-transaction-category/${hiddenTransactionIdInput.value}/`;
                        }

                        // Réinitialiser la logique des sous-catégories pour le formulaire dans la modale
                        const modalCategorySelect = modalFormFieldsContainer.querySelector('#id_category');
                        const modalSubcategorySelect = modalFormFieldsContainer.querySelector('#id_subcategory');
                        const modalDescriptionInput = modalFormFieldsContainer.querySelector('#id_description'); 

                        if (modalCategorySelect && modalSubcategorySelect) {
                            // Peupler les catégories principales avec les icônes et sélectionner la valeur initiale
                            const initialModalCategoryValue = modalCategorySelect.value;
                            populateMainCategories(modalCategorySelect, allCategories, initialModalCategoryValue);


                            const initialModalSubcategoryId = modalSubcategorySelect.value; 
                            if (modalCategorySelect.value) {
                                loadSubcategories(modalCategorySelect.value, modalSubcategorySelect, initialModalSubcategoryId);
                            } else {
                                modalSubcategorySelect.innerHTML = '<option value="">Sélectionner une sous-catégorie</option>';
                                const subcategoryContainer = modalSubcategorySelect.closest('.form-field-group');
                                if (subcategoryContainer) subcategoryContainer.style.display = 'none';
                                updateCategoryIconDisplay(modalSubcategorySelect); // Effacer l'icône si la sous-catégorie est masquée
                            }

                            modalCategorySelect.addEventListener('change', function() {
                                loadSubcategories(this.value, modalSubcategorySelect);
                                updateCategoryIconDisplay(this); // Mettre à jour l'icône pour la catégorie principale
                            });
                            modalSubcategorySelect.addEventListener('change', function() {
                                updateCategoryIconDisplay(this); // Mettre à jour l'icône pour la sous-catégorie
                            });
                            updateCategoryIconDisplay(modalCategorySelect); // Affichage initial pour la catégorie principale
                        }

                        // --- Logique de suggestion pour la modale d'édition ---
                        let modalSuggestionTimeout;
                        if (modalDescriptionInput) {
                            modalDescriptionInput.addEventListener('input', function() {
                                clearTimeout(modalSuggestionTimeout);
                                const description = this.value.trim();

                                if (description.length < 3) {
                                    return;
                                }

                                modalSuggestionTimeout = setTimeout(() => {
                                    fetch(`/suggest-categorization/?description=${encodeURIComponent(description)}`)
                                        .then(response => {
                                            if (!response.ok) {
                                                throw new Error('Erreur lors de la suggestion de catégorisation.');
                                            }
                                            return response.json();
                                        })
                                        .then(data => {
                                            if (data.category_id) {
                                                // Mettre à jour la catégorie principale de la modale
                                                modalCategorySelect.value = data.category_id;
                                                
                                                // Charger les sous-catégories de la modale si une sous-catégorie est suggérée
                                                if (data.subcategory_id) {
                                                    loadSubcategories(data.category_id, modalSubcategorySelect, data.subcategory_id); 
                                                } else {
                                                    modalSubcategorySelect.innerHTML = '<option value="">Sélectionner une sous-catégorie</option>';
                                                    const subcategoryContainer = modalSubcategorySelect.closest('.form-field-group');
                                                    if (subcategoryContainer) subcategoryContainer.style.display = 'none';
                                                    updateCategoryIconDisplay(modalSubcategorySelect); // Effacer l'icône si la sous-catégorie est masquée
                                                }

                                                // Mettre à jour l'icône pour la catégorie principale après avoir défini sa valeur
                                                updateCategoryIconDisplay(modalCategorySelect);

                                                // Mettre à jour les tags de la modale
                                                const modalTagsCheckboxes = modalFormFieldsContainer.querySelectorAll('input[name="tags"]');
                                                modalTagsCheckboxes.forEach(checkbox => {
                                                    checkbox.checked = data.tag_ids.includes(parseInt(checkbox.value));
                                                });

                                                console.log('Suggestion appliquée à la modale:', data);
                                            } else {
                                                console.log('Aucune suggestion trouvée pour la modale.');
                                            }
                                        })
                                        .catch(error => {
                                            console.error('Erreur lors de la suggestion dans la modale:', error);
                                        });
                                }, 500); 
                            });
                        }
                        // --- Fin de la logique de suggestion pour la modale ---

                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        modalFormFieldsContainer.innerHTML = `<p class="text-red-500">Erreur de chargement: ${error.message}</p>`;
                    });
            });
        });

        // Fermer la modale
        closeButton.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        // Fermer la modale si on clique en dehors
        window.addEventListener('click', function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });

        // --- GESTION DE LA SOUMISSION DU FORMULAIRE D'ÉDITION VIA AJAX ---
        modalForm.addEventListener('submit', function(event) {
            event.preventDefault(); 

            const formData = new FormData(modalForm); 
            const transactionId = formData.get('transaction_id'); 

            fetch(modalForm.action, { 
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value 
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json(); 
            })
            .then(data => {
                if (data.success) {
                    modal.style.display = 'none'; 
                    location.reload(); 
                } else {
                    modalFormFieldsContainer.innerHTML = data.errors_html; 
                    
                    // Re-initialiser les catégories et les icônes après une soumission avec erreurs
                    const categoriesDataScript = modalFormFieldsContainer.querySelector('#allCategoriesData');
                    const subcategoriesDataScript = modalFormFieldsContainer.querySelector('#allSubcategoriesData');
                    if (categoriesDataScript && subcategoriesDataScript) {
                        allCategories = JSON.parse(categoriesDataScript.textContent);
                        allSubcategories = JSON.parse(subcategoriesDataScript.textContent);
                    }

                    const modalCategorySelect = modalFormFieldsContainer.querySelector('#id_category');
                    const modalSubcategorySelect = modalFormFieldsContainer.querySelector('#id_subcategory');
                    
                    // Re-peupler les catégories principales avec les icônes et sélectionner la valeur soumise
                    if (modalCategorySelect) {
                        const currentSelectedCategory = modalCategorySelect.value; // La valeur est déjà définie par Django
                        populateMainCategories(modalCategorySelect, allCategories, currentSelectedCategory); // Utiliser populateMainCategories

                        const initialModalSubcategoryId = modalSubcategorySelect ? modalSubcategorySelect.value : null;
                        if (modalCategorySelect.value) {
                            loadSubcategories(modalCategorySelect.value, modalSubcategorySelect, initialModalSubcategoryId);
                        } else {
                            if (modalSubcategorySelect) {
                                modalSubcategorySelect.innerHTML = '<option value="">Sélectionner une sous-catégorie</option>';
                                const subcategoryContainer = modalSubcategorySelect.closest('.form-field-group');
                                if (subcategoryContainer) subcategoryContainer.style.display = 'none';
                                updateCategoryIconDisplay(modalSubcategorySelect);
                            }
                        }

                        modalCategorySelect.addEventListener('change', function() {
                            loadSubcategories(this.value, modalSubcategorySelect);
                            updateCategoryIconDisplay(this);
                        });
                        if (modalSubcategorySelect) {
                            modalSubcategorySelect.addEventListener('change', function() {
                                updateCategoryIconDisplay(this);
                            });
                        }
                        updateCategoryIconDisplay(modalCategorySelect); // Affichage initial pour la catégorie principale
                    }
                }
            })
            .catch(error => {
                console.error('Erreur lors de la soumission du formulaire:', error);
                if (error && error.errors_html) {
                    modalFormFieldsContainer.innerHTML = error.errors_html;
                } else {
                    modalFormFieldsContainer.innerHTML = `<p class="text-red-500">Une erreur inattendue est survenue: ${error.message || JSON.stringify(error)}</p>`;
                }
            });
        });

        // Logique de suppression (remplace window.confirm)
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const transactionId = this.dataset.transactionId;
                
                // Utilisez votre fonction de modale de confirmation personnalisée
                showConfirmationModal(
                    "Confirmer la suppression",
                    "Êtes-vous sûr de vouloir supprimer cette transaction ?",
                    (confirmed) => {
                        if (confirmed) {
                            const tempForm = document.createElement('form');
                            tempForm.method = 'POST';
                            tempForm.action = `/delete-selected-transactions/`; 
                            tempForm.style.display = 'none';

                            const csrfInput = document.createElement('input');
                            csrfInput.type = 'hidden';
                            csrfInput.name = 'csrfmiddlewaretoken';
                            csrfInput.value = document.querySelector('input[name="csrfmiddlewaretoken"]').value; 
                            tempForm.appendChild(csrfInput);

                            const idInput = document.createElement('input');
                            idInput.type = 'hidden';
                            idInput.name = 'transaction_ids'; 
                            idInput.value = transactionId;
                            tempForm.appendChild(idInput);

                            document.body.appendChild(tempForm);
                            tempForm.submit();
                        }
                    }
                );
            });
        });
    });
</script>
